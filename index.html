<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Tecsitel - Sistema de Gestión Empresarial Integrado">
    <meta name="author" content="Tecsitel">
    <title>Tecsitel - Sistema de Gestión</title>
    
    <link rel="icon" type="image/png" href="https://i.imgur.com/6XXdcPR.png">
    
    <style>
        /* ===========================
           Variables y Base
        =========================== */
        :root {
            --primary: #dc143c;
            --primary-dark: #a3102d;
            --white: #ffffff;
            --dark: #1f2937;
            --gray-100: #f9fafb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --success-alpha: rgba(16, 185, 129, 0.1);
            --warning-alpha: rgba(245, 158, 11, 0.1);
            --danger-alpha: rgba(239, 68, 68, 0.1);
            --info-alpha: rgba(59, 130, 246, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --radius: 8px;
            --radius-2xl: 24px;
            --transition: 300ms ease;
            --transition-slow: 500ms ease;
            --font-sans: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { font-family: var(--font-sans); background: var(--gray-100); color: var(--dark); }

        /* ===========================
           NUEVA PANTALLA DE CARGA
        =========================== */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity var(--transition-slow), visibility var(--transition-slow);
            overflow: hidden;
        }

        .loading-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .loading-particles .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 25s infinite ease-in-out;
        }

        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-120vh) rotate(720deg); opacity: 0; }
        }

        .loading-content {
            text-align: center;
            position: relative;
            z-index: 1;
            animation: fadeIn 1s ease;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .loading-logo {
            width: 140px;
            height: 140px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--radius-2xl);
            padding: 25px;
            margin: 0 auto 20px;
            box-shadow: var(--shadow-2xl);
            animation: pulse 2.5s infinite ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); }
        }

        .loading-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .loading-title {
            color: var(--white);
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .loading-status {
            color: rgba(255, 255, 255, 0.8);
            font-size: 16px;
            min-height: 24px;
            margin-top: 8px;
            transition: all var(--transition);
        }
        
        .loading-status.error {
            color: #ffcdd2;
            font-weight: 600;
        }

        /* ===========================
           App Container
        =========================== */
        .app-container {
            display: none;
            min-height: 100vh;
            opacity: 0;
            transition: opacity var(--transition-slow);
        }
        .app-container.loaded { opacity: 1; }
        
        /* ... Aquí iría el resto de tu CSS (sidebar, header, content, etc.) ... */
        /* Para mantener el código legible, se han omitido los estilos que no cambian. */
        /* Debes asegurarte de tenerlos en tu versión final. */
        .sidebar{width:280px;background:var(--dark);color:var(--white);position:fixed;height:100vh;transition:all var(--transition);z-index:1000;}.main-content{margin-left:280px;transition:margin-left var(--transition)}.header{height:70px;background:var(--white);box-shadow:var(--shadow-lg);display:flex;align-items:center;justify-content:space-between;padding:0 30px;position:sticky;top:0;z-index:999;}.content{padding:30px;}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:2000;}.modal.active{display:flex;align-items:center;justify-content:center;}.modal-overlay{position:absolute;width:100%;height:100%;background:rgba(0,0,0,0.5);}.modal-content{background:var(--white);padding:30px;border-radius:var(--radius);z-index:1;width:90%;max-width:500px;}.btn{padding:10px 20px;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;}.btn-primary{background:var(--primary);color:var(--white);}.toast-container{position:fixed;bottom:20px;right:20px;z-index:3000;}.toast{padding:15px;margin-top:10px;border-radius:var(--radius);color:var(--white);box-shadow:var(--shadow-lg);}.toast-success{background:var(--success);}.toast-error{background:var(--danger);}
        .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9999;}.loading-content-inner{background:var(--white);padding:20px;border-radius:var(--radius);display:flex;align-items:center;gap:15px;}.loading-spinner{width:30px;height:30px;border:3px solid rgba(0,0,0,0.1);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;}@keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <!-- Pantalla de Carga Mejorada -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-particles" id="loadingParticles"></div>
        <div class="loading-content">
            <div class="loading-logo">
                <img src="https://i.imgur.com/6XXdcPR.png" alt="Tecsitel Logo">
            </div>
            <h1 class="loading-title">TECSITEL</h1>
            <p class="loading-status" id="loadingStatus">Cargando sistema...</p>
        </div>
    </div>

    <!-- Contenedor Principal de la App -->
    <div class="app-container" id="appContainer">
        <!-- Aquí va el resto de tu HTML (sidebar, header, content, modals, etc.) -->
        <!-- Este contenido no cambia, por lo que se omite por brevedad. -->
        <aside class="sidebar">...</aside>
        <main class="main-content">
            <header class="header">...</header>
            <div class="content">...</div>
        </main>
        <div class="modal" id="newInvoiceModal">...</div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
    // ========================================
    // Configuración Global
    // ========================================
    const CONFIG = {
        API_URL: '/.netlify/functions/database',
        VERSION: '2.2.0', // Versión con corrección de error
    };

    // ========================================
    // Estado de la Aplicación
    // ========================================
    const AppState = {
        user: null,
        invoices: [],
        invoiceCounter: 1,
    };

    // ========================================
    // Inicialización (Lógica Robusta)
    // ========================================
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('DOM Cargado. Iniciando sistema...');
        setupLoadingAnimation(); // Inicia la animación de partículas

        try {
            await initializeApp();
            updateLoadingStatus('¡Sistema listo!', false);
            setTimeout(hideLoadingScreen, 500);
        } catch (error) {
            console.error('Error fatal durante la inicialización:', error);
            // Mostramos el error en la pantalla de carga
            updateLoadingStatus('Error al cargar. Verifique la configuración e intente refrescar.', true);
        }
    });

    async function initializeApp() {
        updateLoadingStatus('Conectando con el servidor...', false);
        await loadDataFromServer();
        
        updateLoadingStatus('Preparando interfaz...', false);
        // Aquí irían tus funciones para renderizar la UI
        // renderUI(); 
        // setupEventListeners();
    }
    
    function updateLoadingStatus(message, isError = false) {
        const statusElement = document.getElementById('loadingStatus');
        if (statusElement) {
            statusElement.textContent = message;
            statusElement.classList.toggle('error', isError);
        }
    }

    function hideLoadingScreen() {
        const loadingScreen = document.getElementById('loadingScreen');
        const appContainer = document.getElementById('appContainer');

        if (loadingScreen && appContainer) {
            loadingScreen.style.opacity = '0';
            loadingScreen.style.visibility = 'hidden';
            appContainer.style.display = 'block'; // O 'flex' según tu layout
            
            setTimeout(() => appContainer.classList.add('loaded'), 50);
        }
    }

    function setupLoadingAnimation() {
        const container = document.getElementById('loadingParticles');
        if (!container) return;
        const particleCount = 20;
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            const size = Math.random() * 15 + 5;
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.animationDelay = `${Math.random() * 25}s`;
            particle.style.animationDuration = `${Math.random() * 15 + 10}s`;
            container.appendChild(particle);
        }
    }

    // ========================================
    // API y Comunicación
    // ========================================
    class TecsitelAPI {
        static async getData() {
            // Se añade un timeout para evitar que se quede esperando indefinidamente
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 segundos de espera

            try {
                const response = await fetch(CONFIG.API_URL, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    // Si el error es 404, es probable que la función no exista o la URL esté mal
                    if (response.status === 404) {
                       throw new Error(`Función no encontrada (404). Verifique la URL de la API.`);
                    }
                    throw new Error(`Error de red: ${response.status} ${response.statusText}`);
                }
                return response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }

        static async saveData(fullData) {
            const response = await fetch(CONFIG.API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(fullData, null, 2),
            });
            if (!response.ok) throw new Error(`Error al guardar: ${response.statusText}`);
            return response.json();
        }
    }

    // ========================================
    // Lógica de Datos
    // ========================================
    async function loadDataFromServer() {
        try {
            const data = await TecsitelAPI.getData();
            // Validamos que el JSON no esté vacío o mal formado
            if (!data || typeof data.invoiceCounter === 'undefined') {
                throw new Error("Los datos recibidos del servidor son inválidos o están vacíos.");
            }
            AppState.invoices = data.invoices || [];
            AppState.invoiceCounter = data.invoiceCounter || 1;
            AppState.user = data.user || { username: 'Usuario', avatar: 'U' };
        } catch (error) {
            console.error("Fallo en loadDataFromServer:", error.message);
            // Propagamos el error para que la función de inicialización lo capture
            throw error;
        }
    }

    async function persistData() {
        showLoading('Guardando...');
        try {
            const fullData = {
                invoices: AppState.invoices,
                invoiceCounter: AppState.invoiceCounter,
                user: AppState.user,
            };
            await TecsitelAPI.saveData(fullData);
            showToast('✅ Cambios guardados.', 'success');
        } catch (error) {
            showToast('❌ Error al guardar.', 'error');
            console.error("Fallo en persistData:", error);
        } finally {
            hideLoading();
        }
    }
    
    // ========================================
    // Utilidades (Toast, Loading Spinner, etc.)
    // ========================================
    function showToast(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toastContainer');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), duration);
    }
    
    function showLoading(message = 'Procesando...') {
        let overlay = document.getElementById('globalLoading');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'globalLoading';
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `<div class="loading-content-inner"><div class="loading-spinner"></div><div class="loading-message">${message}</div></div>`;
            document.body.appendChild(overlay);
        }
    }

    function hideLoading() {
        document.getElementById('globalLoading')?.remove();
    }

    // Aquí iría el resto de tu lógica de UI (saveInvoice, updateDashboard, etc.)
    // que ya tenías y que funcionaba correctamente.

    </script>
</body>
</html>
