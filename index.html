<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Tecsitel - Sistema de Gestión Empresarial Integrado con facturación electrónica, contabilidad y cumplimiento normativo">
    <meta name="author" content="Tecsitel">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#dc143c">
    
    <title>Tecsitel - Sistema de Gestión Empresarial</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://i.imgur.com/6XXdcPR.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/6XXdcPR.png">
    
    <!-- Estilos en línea para evitar dependencias externas y asegurar la carga visual -->
    <style>
        /* ===========================
           Variables y Base
        =========================== */
        :root {
            --primary: #dc143c; --primary-dark: #a3102d; --white: #ffffff; --dark: #1f2937;
            --gray-100: #f9fafb; --gray-200: #f3f4f6; --gray-300: #d1d5db; --gray-600: #6b7280; --gray-700: #4b5563;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --info: #3b82f6;
            --success-alpha: rgba(16, 185, 129, 0.1); --warning-alpha: rgba(245, 158, 11, 0.1);
            --danger-alpha: rgba(239, 68, 68, 0.1); --info-alpha: rgba(59, 130, 246, 0.1);
            --shadow: 0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px 0 rgba(0,0,0,.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0,0,0,.25);
            --radius: 8px; --radius-lg: 12px; --radius-xl: 16px; --radius-2xl: 24px; --radius-full: 9999px;
            --header-height: 70px; --sidebar-width: 280px; --bottom-nav-height: 60px;
            --transition: 300ms ease; --transition-slow: 500ms ease;
            --font-sans: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { -webkit-font-smoothing: antialiased; }
        body { font-family: var(--font-sans); background: var(--gray-100); color: var(--dark); overflow-x: hidden; }

        /* ===========================
           PANTALLA DE CARGA
        =========================== */
        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex; align-items: center; justify-content: center;
            z-index: 10000; transition: opacity var(--transition-slow), visibility var(--transition-slow);
            overflow: hidden;
        }
        .loading-particles { position: absolute; width: 100%; height: 100%; pointer-events: none; }
        .loading-particles .particle {
            position: absolute; background: rgba(255, 255, 255, 0.1); border-radius: 50%;
            animation: float 8s infinite ease-in-out; 
            bottom: -200px; 
        }
        @keyframes float {
            from {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            to {
                transform: translateY(-120vh) rotate(720deg);
                opacity: 0;
            }
        }
        .loading-content { text-align: center; position: relative; z-index: 1; animation: fadeIn 1s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .loading-logo {
            width: 140px; height: 140px; background: rgba(255, 255, 255, 0.95); border-radius: var(--radius-2xl);
            padding: 25px; margin: 0 auto 20px; box-shadow: var(--shadow-2xl);
            animation: pulse 2.5s infinite ease-in-out; display: flex; align-items: center; justify-content: center;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,0.4); } 50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255,255,255,0); } }
        .loading-logo img { width: 100%; height: 100%; object-fit: contain; }
        .loading-title { color: var(--white); font-size: 28px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .loading-status { color: rgba(255, 255, 255, 0.8); font-size: 16px; min-height: 24px; margin-top: 8px; transition: all var(--transition); }
        .loading-status.error { color: #ffcdd2; font-weight: 600; }

        /* ===========================
           App Container y UI General
        =========================== */
        .app-container { display: none; min-height: 100vh; opacity: 0; transition: opacity var(--transition-slow); }
        .app-container.loaded { opacity: 1; display: flex; }
        .sidebar{width:var(--sidebar-width);background:linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);color:var(--white);position:fixed;height:100vh;transition:all var(--transition);z-index:1000;display:flex;flex-direction:column}
        .sidebar-header{padding:30px 20px;text-align:center;border-bottom:1px solid rgba(255,255,255,.1)}.logo{width:80px;height:80px;background:var(--white);border-radius:var(--radius-xl);margin:0 auto 15px;padding:15px;cursor:pointer}.logo img{width:100%;height:100%}.sidebar-title{font-size:20px;font-weight:700;margin:0}.sidebar-subtitle{font-size:14px;opacity:.8;margin-top:4px}.nav-menu{padding:20px 0;flex-grow:1;overflow-y:auto}.nav-item{display:flex;align-items:center;gap:15px;padding:15px 25px;cursor:pointer;transition:background .2s ease, padding-left .2s ease;border:none;background:0 0;color:var(--white);width:100%;text-align:left;font-size:15px}.nav-item .nav-icon{font-size:24px;width:28px;text-align:center}.nav-item.active,.nav-item:hover{background:rgba(255,255,255,.1);padding-left:30px}.main-content{margin-left:var(--sidebar-width);transition:margin-left var(--transition);width:calc(100% - var(--sidebar-width));display:flex;flex-direction:column;min-height:100vh}.header{height:var(--header-height);background:var(--white);box-shadow:var(--shadow);display:flex;align-items:center;justify-content:space-between;padding:0 30px;position:sticky;top:0;z-index:999}.page-title{font-size:24px;font-weight:700}.header-right{display:flex;align-items:center;gap:20px}.user-avatar{width:40px;height:40px;background:var(--primary);color:var(--white);border-radius:var(--radius-full);display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer}.content{padding:30px;flex-grow:1}.tab-content{display:none}.tab-content.active{display:block;animation:fadeIn .5s ease}.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}.stat-card{background:var(--white);border-radius:var(--radius-lg);padding:24px;box-shadow:var(--shadow)}.stat-header{display:flex;justify-content:space-between;align-items:flex-start}.stat-value{font-size:28px;font-weight:700}.stat-label{color:var(--gray-600)}.stat-icon{width:48px;height:48px;border-radius:var(--radius);display:flex;align-items:center;justify-content:center;font-size:24px}.panel{background:var(--white);border-radius:var(--radius-lg);box-shadow:var(--shadow);margin-bottom:24px}.panel-header{padding:20px 24px;border-bottom:1px solid var(--gray-200);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}.panel-title{font-size:18px;font-weight:700}.panel-body{padding:24px}.table-responsive{overflow-x:auto}.table{width:100%;border-collapse:collapse;min-width:600px}.table th,.table td{padding:12px 16px;text-align:left;border-bottom:1px solid var(--gray-200)}.table th{background:var(--gray-100)}.badge{padding:4px 10px;border-radius:var(--radius-full);font-size:12px;font-weight:600}.badge-success{background:var(--success-alpha);color:var(--success)}.badge-warning{background:var(--warning-alpha);color:var(--warning)}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:2000}.modal.active{display:flex;align-items:center;justify-content:center;animation:fadeIn .3s ease}.modal-overlay{position:absolute;width:100%;height:100%;background:rgba(0,0,0,.5)}.modal-content{background:var(--white);padding:30px;border-radius:var(--radius-lg);z-index:1;width:90%;max-width:600px;max-height:90vh;display:flex;flex-direction:column;animation:slideUp .3s ease}@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid var(--gray-200)}.modal-title{font-size:20px;font-weight:700}.modal-body{overflow-y:auto;padding-right:15px;margin-right:-15px}.modal-close{background:0 0;border:none;font-size:24px;cursor:pointer}.modal-footer{margin-top:20px;padding-top:15px;border-top:1px solid var(--gray-200);display:flex;justify-content:flex-end;gap:10px}.btn{padding:10px 20px;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;transition:all var(--transition)}.btn-primary{background:var(--primary);color:var(--white)}.btn-primary:hover{background:var(--primary-dark)}.btn-secondary{background:var(--gray-200)}.btn-danger{background:var(--danger);color:var(--white)}.btn-danger:hover{background:var(--danger-light)}.btn-sm{padding:6px 12px;font-size:12px}.form-group{margin-bottom:20px}.form-label{display:block;margin-bottom:8px;font-weight:600}.form-input,.form-select,.form-textarea{width:100%;padding:10px;border:1px solid var(--gray-300);border-radius:var(--radius)}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:20px}.toast-container{position:fixed;bottom:20px;right:20px;z-index:3000}.toast{padding:15px;margin-top:10px;border-radius:var(--radius);color:var(--white);box-shadow:var(--shadow-lg);animation:fadeIn .3s}.toast-success{background:var(--success)}.toast-error{background:var(--danger)}.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.8);display:flex;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(2px)}.loading-spinner{width:40px;height:40px;border:4px solid var(--primary-dark);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
        .alert{padding:16px 20px;border-radius:var(--radius);margin-bottom:20px;display:flex;gap:12px;border:1px solid transparent}.alert-info{background:var(--info-alpha);color:var(--info);border-color:rgba(59,130,246,.2)}.alert-icon{font-size:20px;flex-shrink:0}.alert-content strong{display:block;margin-bottom:4px}.quick-actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin-top:30px}.action-card{background:var(--white);border:2px dashed var(--gray-300);border-radius:var(--radius-lg);padding:24px;text-align:center;cursor:pointer;transition:all var(--transition)}.action-card:hover{border-color:var(--primary);border-style:solid;transform:translateY(-2px);box-shadow:var(--shadow-md)}.action-icon{font-size:32px;margin-bottom:12px}.action-title{font-weight:700;margin-bottom:4px;font-size:16px}.action-desc{font-size:13px;color:var(--gray-600)}.compliance-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;margin-bottom:24px}.compliance-card{background:var(--white);border-radius:var(--radius-lg);padding:24px;box-shadow:var(--shadow)}.compliance-header{display:flex;align-items:center;gap:16px;margin-bottom:20px}.compliance-icon{width:60px;height:60px;border-radius:var(--radius-lg);display:flex;align-items:center;justify-content:center;font-size:32px}.compliance-info h3{margin:0;font-size:20px}.compliance-info p{color:var(--gray-600);margin:0;font-size:14px}.compliance-list{display:flex;flex-direction:column;gap:12px}.compliance-item{display:flex;align-items:center;gap:12px}.check-icon{width:24px;height:24px;border-radius:var(--radius-full);display:flex;align-items:center;justify-content:center;color:var(--white);font-size:14px}.compliance-progress{margin-top:20px}.progress-header{display:flex;justify-content:space-between;margin-bottom:8px;font-size:14px}.progress{height:8px;background:var(--gray-200);border-radius:var(--radius-full);overflow:hidden}.progress-bar{height:100%;background:var(--primary);border-radius:var(--radius-full);transition:width var(--transition)}.employee-info{display:flex;align-items:center;gap:12px}.employee-avatar{width:40px;height:40px;border-radius:var(--radius-full);display:flex;align-items:center;justify-content:center;font-weight:700}.employee-details .employee-name{font-weight:600}.employee-details .employee-role{font-size:12px;color:var(--gray-600)}
        .balance-sheet{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}.balance-section{background:var(--gray-100);padding:20px;border-radius:var(--radius);border-left:4px solid var(--primary)}.balance-section h4{margin:0 0 16px;color:var(--dark);font-size:16px;font-weight:700}.balance-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--gray-200)}.balance-item:last-child{border-bottom:none}.balance-total{font-weight:700;margin-top:12px;padding-top:12px;border-top:2px solid var(--primary);color:var(--dark);display:flex;justify-content:space-between}
        .bottom-nav{display:none}
        .hidden { display: none !important; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; }
        
        /* ===========================
           Responsive Design
        =========================== */
        @media(max-width:1024px){.sidebar{transform:translateX(-100%);z-index:1001}.sidebar.active{transform:translateX(0);box-shadow:var(--shadow-2xl)}.main-content{margin-left:0;width:100%}.menu-toggle{display:block!important}}
        @media(max-width:768px){.content{padding:20px;padding-bottom:calc(var(--bottom-nav-height) + 20px)}.header{padding:0 20px}.page-title{font-size:20px}.table{min-width:auto}.hide-mobile{display:none}.form-row{grid-template-columns:1fr}.bottom-nav{position:fixed;bottom:0;left:0;right:0;height:var(--bottom-nav-height);background:var(--white);display:flex;box-shadow:0 -2px 10px rgba(0,0,0,.1);z-index:1000}.bottom-nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--gray-600);text-decoration:none;font-size:11px;gap:4px;position:relative}.bottom-nav-item.active{color:var(--primary)}.bottom-nav-item.active::before{content:'';position:absolute;top:0;width:30px;height:3px;background:var(--primary);border-radius:0 0 3px 3px}.bottom-nav-icon{font-size:22px}}
    </style>
</head>
<body>
    <!-- Pantalla de Carga Mejorada -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-particles" id="loadingParticles"></div>
        <div class="loading-content">
            <div class="loading-logo">
                <img src="https://i.imgur.com/6XXdcPR.png" alt="Tecsitel Logo">
            </div>
            <h1 class="loading-title">TECSITEL</h1>
            <p class="loading-status" id="loadingStatus">Cargando sistema...</p>
        </div>
    </div>

    <!-- Contenedor Principal de la App -->
    <div class="app-container" id="appContainer">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo" onclick="showTab('dashboard')">
                    <img src="https://i.imgur.com/6XXdcPR.png" alt="Tecsitel">
                </div>
                <h2 class="sidebar-title">TECSITEL</h2>
                <p class="sidebar-subtitle">Sistema de Gestión v2.8</p>
            </div>
            <nav class="nav-menu">
                <button class="nav-item active" data-tab="dashboard">
                    <span class="nav-icon">📊</span><span class="nav-text">Dashboard</span>
                </button>
                <button class="nav-item" data-tab="invoices">
                    <span class="nav-icon">📄</span><span class="nav-text">Facturas</span>
                </button>
                <button class="nav-item" data-tab="accounting">
                    <span class="nav-icon">💰</span><span class="nav-text">Contabilidad</span>
                </button>
                 <button class="nav-item" data-tab="personnel">
                    <span class="nav-icon">👥</span><span class="nav-text">Personal</span>
                </button>
                <button class="nav-item" data-tab="compliance">
                    <span class="nav-icon">⚖️</span><span class="nav-text">Cumplimiento</span>
                </button>
                <button class="nav-item" data-tab="sharepoint">
                    <span class="nav-icon">☁️</span><span class="nav-text">Respaldos</span>
                </button>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <button class="menu-toggle" style="display:none;" onclick="document.getElementById('sidebar').classList.toggle('active')">☰</button>
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
                <div class="header-right">
                    <div class="user-avatar" id="userAvatar" onclick="logout()">A</div>
                </div>
            </header>

            <div class="content">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-header"><div class="stat-info"><div class="stat-value" id="totalIncome">S/ 0.00</div><div class="stat-label">Ingresos Totales</div></div><div class="stat-icon" style="background:var(--success-alpha);color:var(--success)">💰</div></div></div>
                        <div class="stat-card"><div class="stat-header"><div class="stat-info"><div class="stat-value" id="pendingInvoices">0</div><div class="stat-label">Facturas Pendientes</div></div><div class="stat-icon" style="background:var(--warning-alpha);color:var(--warning)">📋</div></div></div>
                        <div class="stat-card"><div class="stat-header"><div class="stat-info"><div class="stat-value" id="netBalance">S/ 0.00</div><div class="stat-label">Balance Neto</div></div><div class="stat-icon" style="background:var(--info-alpha);color:var(--info)">📈</div></div></div>
                    </div>
                    <div class="panel">
                         <div class="panel-header">
                            <h3 class="panel-title">📊 Actividad Reciente</h3>
                            <button class="btn btn-primary" onclick="showModal('newInvoice')">
                                <span class="btn-icon">➕</span>
                                <span class="btn-text">Nueva Factura</span>
                            </button>
                        </div>
                        <div class="panel-body">
                            <div class="alert alert-info">
                                <span class="alert-icon">ℹ️</span>
                                <div class="alert-content">
                                    <strong>Sistema Actualizado</strong>
                                    Cumpliendo con normativas SUNAT, SUNAFIL y MINTRA.
                                </div>
                            </div>
                            <div class="table-responsive"><table class="table" id="recentInvoicesTable"><thead><tr><th>N° Factura</th><th>Cliente</th><th class="hide-mobile">Total</th><th>Estado</th></tr></thead><tbody><tr><td colspan="4" style="text-align: center;">No hay facturas registradas.</td></tr></tbody></table></div>
                        </div>
                    </div>
                     <div class="quick-actions">
                        <div class="action-card" onclick="showModal('newInvoice')"><div class="action-icon">➕</div><div class="action-title">Nueva Factura</div><div class="action-desc">Crear comprobante</div></div>
                        <div class="action-card" onclick="showModal('registerPayment')"><div class="action-icon">💵</div><div class="action-title">Registrar Cobro</div><div class="action-desc">Ingresar pago</div></div>
                        <div class="action-card" onclick="showTab('personnel')"><div class="action-icon">👥</div><div class="action-title">Ver Personal</div><div class="action-desc">Gestionar equipo</div></div>
                        <div class="action-card" onclick="showModal('timeEntry')"><div class="action-icon">✍️</div><div class="action-title">Control de Asistencia</div><div class="action-desc">Registrar marcación</div></div>
                    </div>
                </div>
                
                <!-- Invoices Tab -->
                <div id="invoices" class="tab-content">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">Todas las Facturas</h3>
                            <div class="panel-actions" style="gap: 10px;">
                                <input type="file" id="uploadInvoiceInput" class="hidden" multiple onchange="handleFileUpload(this.files)" accept=".pdf,.jpg,.jpeg,.png">
                                <button class="btn btn-secondary" onclick="document.getElementById('uploadInvoiceInput').click()">Subir Facturas</button>
                                <button class="btn btn-primary" onclick="showModal('newInvoice')">➕ Nueva Factura</button>
                            </div>
                        </div>
                        <div class="panel-body"><div class="table-responsive"><table class="table" id="allInvoicesTable"><thead><tr><th>N° Factura</th><th>Cliente</th><th class="hide-mobile">RUC</th><th>Total</th><th>Estado</th><th>Acciones</th></tr></thead><tbody><tr><td colspan="6" style="text-align: center;">No hay facturas registradas.</td></tr></tbody></table></div></div>
                    </div>
                </div>

                <!-- Accounting Tab -->
                <div id="accounting" class="tab-content">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">💰 Estado de Situación Financiera</h3>
                        </div>
                        <div class="panel-body">
                           <div class="balance-sheet">
                                <div class="balance-section">
                                    <h4>ACTIVOS</h4>
                                    <div class="balance-item"><span>Efectivo y Bancos</span><span id="cashBalance">S/ 12,500.00</span></div>
                                    <div class="balance-item"><span>Cuentas por Cobrar</span><span id="receivables">S/ 7,800.00</span></div>
                                    <div class="balance-item"><span>Inventario</span><span>S/ 4,200.00</span></div>
                                    <div class="balance-total"><span>Total Activos</span><span id="totalAssets">S/ 24,500.00</span></div>
                                </div>
                                <div class="balance-section">
                                    <h4>PASIVOS</h4>
                                    <div class="balance-item"><span>Cuentas por Pagar</span><span>S/ 3,100.00</span></div>
                                    <div class="balance-item"><span>Impuestos por Pagar</span><span id="taxesPayable">S/ 1,250.00</span></div>
                                    <div class="balance-total"><span>Total Pasivos</span><span id="totalLiabilities">S/ 4,350.00</span></div>
                                </div>
                                <div class="balance-section">
                                    <h4>PATRIMONIO</h4>
                                    <div class="balance-item"><span>Capital Social</span><span>S/ 15,000.00</span></div>
                                    <div class="balance-item"><span>Utilidades Retenidas</span><span id="retainedEarnings">S/ 5,150.00</span></div>
                                    <div class="balance-total"><span>Total Patrimonio</span><span id="totalEquity">S/ 20,150.00</span></div>
                                </div>
                           </div>
                        </div>
                    </div>
                </div>

                <!-- Personnel Tab (Unified) -->
                <div id="personnel" class="tab-content">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">👥 Gestión de Empleados</h3>
                            <button class="btn btn-primary" onclick="showModal('newEmployee')">➕ Nuevo Empleado</button>
                        </div>
                        <div class="panel-body">
                           <div class="table-responsive">
                               <table class="table" id="employeesTable">
                                   <thead><tr><th>DNI</th><th>Nombre Completo</th><th>Estado</th><th>Acciones</th></tr></thead>
                                   <tbody></tbody>
                               </table>
                           </div>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">⏰ Control de Asistencia Digital</h3>
                            <button class="btn btn-primary" onclick="showModal('timeEntry')">➕ Nueva Marcación</button>
                        </div>
                        <div class="panel-body">
                           <div class="alert alert-info"><span class="alert-icon">ℹ️</span><div class="alert-content"><strong>Cumplimiento SUNAFIL.</strong> El registro de control de asistencia es obligatorio.</div></div>
                           <div class="table-responsive">
                               <table class="table" id="timeTrackingTable">
                                   <thead><tr><th>Trabajador</th><th>Entrada</th><th>Salida</th><th>Estado</th><th>Acciones</th></tr></thead>
                                   <tbody></tbody>
                               </table>
                           </div>
                        </div>
                    </div>
                </div>

                <!-- Compliance Tab -->
                <div id="compliance" class="tab-content">
                     <div class="compliance-grid">
                        <div class="compliance-card">
                            <div class="compliance-header"><div class="compliance-icon" style="background:rgba(16,185,129,.1)">🏛️</div><div class="compliance-info"><h3>SUNAT</h3><p>Superintendencia Nacional</p></div></div>
                            <div class="compliance-list"><div class="compliance-item"><div class="check-icon" style="background:var(--success)">✓</div><span>Facturación Electrónica 3.0</span></div><div class="compliance-item"><div class="check-icon" style="background:var(--success)">✓</div><span>Libros Electrónicos al día</span></div><div class="compliance-item"><div class="check-icon" style="background:var(--warning)">!</div><span>PDT 621 - Vence en 10 días</span></div></div>
                            <div class="compliance-progress"><div class="progress-header"><span>Cumplimiento</span><strong>95%</strong></div><div class="progress"><div class="progress-bar" style="width:95%;background:var(--success)"></div></div></div>
                        </div>
                        <div class="compliance-card">
                            <div class="compliance-header"><div class="compliance-icon" style="background:rgba(59,130,246,.1)">⚖️</div><div class="compliance-info"><h3>SUNAFIL</h3><p>Fiscalización Laboral</p></div></div>
                            <div class="compliance-list"><div class="compliance-item"><div class="check-icon" style="background:var(--success)">✓</div><span>T-REGISTRO actualizado</span></div><div class="compliance-item"><div class="check-icon" style="background:var(--success)">✓</div><span>Control de asistencia digital</span></div><div class="compliance-item"><div class="check-icon" style="background:var(--success)">✓</div><span>SCTR vigente</span></div></div>
                            <div class="compliance-progress"><div class="progress-header"><span>Cumplimiento</span><strong>100%</strong></div><div class="progress"><div class="progress-bar" style="width:100%;background:var(--success)"></div></div></div>
                        </div>
                    </div>
                </div>

                <!-- SharePoint Tab -->
                <div id="sharepoint" class="tab-content">
                    <div class="panel">
                        <div class="panel-header"><h3 class="panel-title">☁️ Sistema de Respaldos</h3></div>
                        <div class="panel-body">
                            <p>Genera y descarga un respaldo completo de todos los datos de la aplicación en un único archivo CSV.</p>
                            <button class="btn btn-success" onclick="downloadFullBackup()">Descargar Respaldo Completo (CSV)</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <nav class="bottom-nav" id="bottomNav">
                <a href="#" class="bottom-nav-item active" data-tab="dashboard"><span class="bottom-nav-icon">📊</span><span>Dashboard</span></a>
                <a href="#" class="bottom-nav-item" data-tab="invoices"><span class="bottom-nav-icon">📄</span><span>Facturas</span></a>
                <a href="#" class="bottom-nav-item" data-tab="personnel"><span class="bottom-nav-icon">👥</span><span>Personal</span></a>
                <a href="#" class="bottom-nav-item" data-tab="accounting"><span class="bottom-nav-icon">💰</span><span>Finanzas</span></a>
                <a href="#" class="bottom-nav-item" data-tab="compliance"><span class="bottom-nav-icon">⚖️</span><span>Legal</span></a>
            </nav>
        </main>
    </div>

    <div class="modal" id="newInvoiceModal">
        <div class="modal-overlay" onclick="closeModal('newInvoice')"></div>
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">Nueva Factura</h2><button class="modal-close" onclick="closeModal('newInvoice')">&times;</button></div>
            <div class="modal-body">
                <form id="invoiceForm" onsubmit="saveInvoice(event)">
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">RUC Cliente*</label><input type="text" class="form-input" name="clientRuc" placeholder="20100055237" required></div>
                        <div class="form-group"><label class="form-label">Razón Social*</label><input type="text" class="form-input" name="clientName" placeholder="Mi Cliente SAC" required></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Descripción*</label>
                        <textarea class="form-textarea" name="description" placeholder="Servicio de consultoría..." required></textarea>
                    </div>
                     <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Moneda*</label>
                            <select class="form-select" name="currency" onchange="handleCurrencyChange(this.value)">
                                <option value="PEN">Soles (S/)</option>
                                <option value="USD">Dólares ($)</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="exchangeRateGroup">
                            <label class="form-label">Tipo de Cambio (S/)</label>
                            <input type="number" step="0.001" class="form-input" name="exchangeRate" value="3.75">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Monto Base* (<span class="currency-symbol">S/</span>)</label>
                        <input type="number" step="0.01" class="form-input" name="amount" placeholder="1500.00" required oninput="calculateTotal()">
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="isExportInvoice" onchange="calculateTotal()">
                        <label for="isExportInvoice">Factura de Exportación (sin IGV)</label>
                    </div>
                    <div class="form-group" id="totalAmountGroup">
                        <label class="form-label">Total (IGV Incl.) (<span class="currency-symbol">S/</span>)</label>
                        <input type="text" class="form-input" name="totalAmount" readonly>
                    </div>
                    <div class="form-group">
                        <label for="invoiceFile" class="form-label">Adjuntar Archivo (PDF, JPG, PNG)</label>
                        <input type="file" id="invoiceFile" class="form-input" name="invoiceFile" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal('newInvoice')">Cancelar</button><button type="submit" form="invoiceForm" class="btn btn-primary">Guardar</button></div>
        </div>
    </div>
    
    <div class="modal" id="registerPaymentModal">
        <div class="modal-overlay" onclick="closeModal('registerPayment')"></div>
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">Registrar Cobro</h2><button class="modal-close" onclick="closeModal('registerPayment')">&times;</button></div>
            <div class="modal-body">
                <form id="paymentForm" onsubmit="savePayment(event)">
                    <div class="form-group"><label class="form-label">N° de Factura*</label><input type="text" class="form-input" name="invoiceNumber" placeholder="F001-0001" required></div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Moneda*</label>
                            <select class="form-select" name="currency" onchange="updateCurrencySymbols(this.value, 'paymentForm')">
                                <option value="PEN">Soles (S/)</option>
                                <option value="USD">Dólares ($)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Monto Cobrado* (<span class="currency-symbol">S/</span>)</label>
                            <input type="number" step="0.01" class="form-input" name="paymentAmount" placeholder="1770.00" required>
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label">Fecha de Cobro*</label><input type="date" class="form-input" name="paymentDate" required></div>
                    <div class="form-group"><label class="form-label">Método de Pago</label><select class="form-select" name="paymentMethod"><option>Transferencia</option><option>Efectivo</option><option>Yape/Plin</option></select></div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal('registerPayment')">Cancelar</button><button type="submit" form="paymentForm" class="btn btn-primary">Registrar</button></div>
        </div>
    </div>

    <div class="modal" id="timeEntryModal">
        <div class="modal-overlay" onclick="closeModal('timeEntry')"></div>
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">Marcar Asistencia</h2><button class="modal-close" onclick="closeModal('timeEntry')">&times;</button></div>
            <div class="modal-body">
                <form id="timeEntryForm" onsubmit="saveTimeEntry(event)">
                    <div class="form-group">
                        <label class="form-label">Empleado*</label>
                        <select class="form-select" name="employeeId" required>
                            <option value="">Seleccione un empleado...</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Tipo de Marcación*</label>
                        <select class="form-select" name="entryType" required>
                            <option value="Entrada">Entrada</option>
                            <option value="Salida">Salida</option>
                            <option value="Inicio Refrigerio">Inicio Refrigerio</option>
                            <option value="Fin Refrigerio">Fin Refrigerio</option>
                        </select>
                    </div>
                     <div class="form-group"><label class="form-label">Fecha y Hora</label><input type="text" class="form-input" name="entryDateTime" readonly></div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal('timeEntry')">Cancelar</button><button type="submit" form="timeEntryForm" class="btn btn-primary">Registrar Marcación</button></div>
        </div>
    </div>

    <div class="modal" id="newEmployeeModal">
        <div class="modal-overlay" onclick="closeModal('newEmployee')"></div>
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">Nuevo Empleado</h2><button class="modal-close" onclick="closeModal('newEmployee')">&times;</button></div>
            <div class="modal-body">
                <form id="newEmployeeForm" onsubmit="saveEmployee(event)">
                    <div class="form-group"><label class="form-label">DNI*</label><input type="text" pattern="[0-9]{8}" maxlength="8" class="form-input" name="employeeDni" placeholder="71234567" required></div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Nombres*</label><input type="text" class="form-input" name="employeeFirstName" placeholder="Juan" required></div>
                        <div class="form-group"><label class="form-label">Apellidos*</label><input type="text" class="form-input" name="employeeLastName" placeholder="Pérez García" required></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal('newEmployee')">Cancelar</button><button type="submit" form="newEmployeeForm" class="btn btn-primary">Guardar Empleado</button></div>
        </div>
    </div>


    <div class="toast-container" id="toastContainer"></div>

    <script>
    // ========================================
    // Configuración Global y Estado
    // ========================================
    const CONFIG = {
        IGV_RATE: 0.18,
        LOADING_DURATION: 5000,
    };

    const AppState = { 
        user: { name: 'Admin', avatar: 'A' },
        invoices: [],
        employees: [],
        timeEntries: [],
        invoiceCounter: 1,
    };

    // ========================================
    // Datos de Ejemplo para Prototipo (PYME)
    // ========================================
    function loadSampleData() {
        AppState.employees = [
            { dni: '48756231', firstName: 'Juan', lastName: 'Pérez García', avatar: 'JP' },
            { dni: '71234567', firstName: 'María', lastName: 'Rodríguez', avatar: 'MR' },
            { dni: '78945612', firstName: 'Carlos', lastName: 'Sánchez', avatar: 'CS' },
            { dni: '12345678', firstName: 'Ana', lastName: 'Torres', avatar: 'AT' },
        ];
        
        AppState.invoices = [];
        AppState.timeEntries = [];
        AppState.invoiceCounter = 1;
    }


    // ========================================
    // Inicialización
    // ========================================
    document.addEventListener('DOMContentLoaded', () => {
        setupLoadingAnimation();
        updateLoadingStatus('Cargando datos de la empresa...', false);
        loadSampleData();

        setTimeout(() => {
            updateLoadingStatus('¡Sistema listo!', false);
            const loadingScreen = document.getElementById('loadingScreen');
            const appContainer = document.getElementById('appContainer');

            if (loadingScreen && appContainer) {
                loadingScreen.style.opacity = '0';
                loadingScreen.style.visibility = 'hidden';
                appContainer.style.display = 'flex';
                
                setTimeout(() => {
                    appContainer.classList.add('loaded');
                    renderAll();
                    setupEventListeners();
                }, 50); 
            }
        }, CONFIG.LOADING_DURATION);
    });
    
    function updateLoadingStatus(message, isError = false) {
        const statusElement = document.getElementById('loadingStatus');
        if (statusElement) {
            statusElement.textContent = message;
            statusElement.classList.toggle('error', isError);
        }
    }

    function setupLoadingAnimation() {
        const container = document.getElementById('loadingParticles');
        if (!container) return;
        const particleCount = 50;
        for (let i = 0; i < particleCount; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            const size = Math.random() * 6 + 2;
            p.style.cssText = `
                width:${size}px;
                height:${size}px;
                left:${Math.random()*100}%;
                animation-delay:${Math.random() * 8}s;
                animation-duration:${Math.random() * 5 + 4}s;
            `;
            container.appendChild(p);
        }
    }

    // ========================================
    // Lógica de Renderizado
    // ========================================
    function renderAll() {
        document.getElementById('userAvatar').textContent = AppState.user?.avatar || 'U';
        renderDashboard();
        renderInvoices();
        renderEmployees();
        renderTimeTracking();
        renderAccounting();
        renderEmployeeOptions();
    }
    
    function renderDashboard() {
        const totalIncome = AppState.invoices.filter(inv => inv.status === 'Pagada').reduce((sum, inv) => sum + (inv.currency === 'USD' ? inv.amount * 3.75 : inv.amount), 0);
        const pendingInvoices = AppState.invoices.filter(inv => inv.status === 'Pendiente').length;
        const netBalance = totalIncome; 

        document.getElementById('totalIncome').textContent = `S/ ${totalIncome.toFixed(2)}`;
        document.getElementById('pendingInvoices').textContent = pendingInvoices;
        document.getElementById('netBalance').textContent = `S/ ${netBalance.toFixed(2)}`;
    }

    function renderInvoices() {
        const recentTbody = document.querySelector('#recentInvoicesTable tbody');
        const allTbody = document.querySelector('#allInvoicesTable tbody');
        recentTbody.innerHTML = '';
        allTbody.innerHTML = '';

        if (AppState.invoices.length === 0) {
            const emptyRow = `<tr><td colspan="6" style="text-align: center;">No hay facturas registradas.</td></tr>`;
            recentTbody.innerHTML = emptyRow.replace('colspan="6"', 'colspan="4"');
            allTbody.innerHTML = emptyRow;
            return;
        }

        const sortedInvoices = [...AppState.invoices].sort((a, b) => new Date(b.date) - new Date(a.date));

        sortedInvoices.forEach((inv, index) => {
            const symbol = inv.currency === 'PEN' ? 'S/' : '$';
            const total = inv.isExport ? inv.amount : inv.amount * (1 + CONFIG.IGV_RATE);
            const statusClass = inv.status === 'Pagada' ? 'success' : 'warning';
            const allInvoicesRow = `
                <tr>
                    <td>${inv.invoice_number}</td>
                    <td>${inv.clientName}</td>
                    <td class="hide-mobile">${inv.clientRuc}</td>
                    <td>${symbol} ${total.toFixed(2)}</td>
                    <td><span class="badge badge-${statusClass}">${inv.status}</span></td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteItem('invoice', ${inv.id})">Borrar</button></td>
                </tr>`;
            
            if (index < 5) {
                const recentInvoicesRow = `
                <tr>
                    <td>${inv.invoice_number}</td>
                    <td>${inv.clientName}</td>
                    <td class="hide-mobile">${symbol} ${total.toFixed(2)}</td>
                    <td><span class="badge badge-${statusClass}">${inv.status}</span></td>
                </tr>`;
                recentTbody.innerHTML += recentInvoicesRow;
            }
            allTbody.innerHTML += allInvoicesRow;
        });
    }

    function renderEmployees() {
        const tableBody = document.querySelector('#employeesTable tbody');
        tableBody.innerHTML = '';
        AppState.employees.forEach(emp => {
            tableBody.innerHTML += `<tr><td>${emp.dni}</td><td>${emp.firstName} ${emp.lastName}</td><td><span class="badge badge-success">Activo</span></td><td><button class="btn btn-danger btn-sm" onclick="deleteItem('employee', '${emp.dni}')">Borrar</button></td></tr>`;
        });
    }

    function renderTimeTracking() {
        const tableBody = document.querySelector('#timeTrackingTable tbody');
        tableBody.innerHTML = '';
        if (AppState.timeEntries.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">No hay marcaciones registradas.</td></tr>`;
            return;
        }
        AppState.timeEntries.forEach(entry => {
            const statusClass = entry.status === 'Completo' ? 'success' : 'warning';
            tableBody.innerHTML += `
                <tr>
                    <td>
                        <div class="employee-info">
                            <div class="employee-avatar" style="background:#dbeafe;color:#1e40af">${entry.avatar}</div>
                            <div class="employee-details"><div class="employee-name">${entry.name}</div></div>
                        </div>
                    </td>
                    <td>${entry.entryTime}</td>
                    <td>${entry.exitTime}</td>
                    <td><span class="badge badge-${statusClass}">${entry.status}</span></td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteItem('timeEntry', ${entry.id})">Borrar</button></td>
                </tr>`;
        });
    }
    
    function renderAccounting() {
        // Mockup data for financial statement
        const cash = 12500.00;
        const receivables = 7800.00;
        const inventory = 4200.00;
        const totalAssets = cash + receivables + inventory;
        
        const payables = 3100.00;
        const taxes = 1250.00;
        const totalLiabilities = payables + taxes;
        
        const capital = 15000.00;
        const retainedEarnings = totalAssets - totalLiabilities - capital;
        const totalEquity = capital + retainedEarnings;
        
        document.getElementById('cashBalance').textContent = `S/ ${cash.toFixed(2)}`;
        document.getElementById('receivables').textContent = `S/ ${receivables.toFixed(2)}`;
        document.getElementById('totalAssets').textContent = `S/ ${totalAssets.toFixed(2)}`;
        document.getElementById('taxesPayable').textContent = `S/ ${taxes.toFixed(2)}`;
        document.getElementById('totalLiabilities').textContent = `S/ ${totalLiabilities.toFixed(2)}`;
        document.getElementById('retainedEarnings').textContent = `S/ ${retainedEarnings.toFixed(2)}`;
        document.getElementById('totalEquity').textContent = `S/ ${totalEquity.toFixed(2)}`;
    }
    
    function renderEmployeeOptions() {
        const select = document.querySelector('#timeEntryForm [name="employeeId"]');
        if (!select) return;
        select.innerHTML = '<option value="">Seleccione un empleado...</option>';
        AppState.employees.forEach(emp => {
            const option = document.createElement('option');
            option.value = emp.dni;
            option.textContent = `${emp.firstName} ${emp.lastName} (${emp.dni})`;
            select.appendChild(option);
        });
    }

    function handleCurrencyChange(currency) {
        const exchangeRateGroup = document.getElementById('exchangeRateGroup');
        exchangeRateGroup.classList.toggle('hidden', currency === 'PEN');
        updateCurrencySymbols(currency, 'invoiceForm');
        calculateTotal();
    }
    
    function updateCurrencySymbols(currency, formId) {
        const symbol = currency === 'PEN' ? 'S/' : '$';
        const form = document.getElementById(formId);
        if(form) {
            form.querySelectorAll('.currency-symbol').forEach(span => {
                span.textContent = symbol;
            });
        }
    }
    
    function logout() {
        if (confirm('¿Estás seguro de que deseas cerrar sesión?')) {
            showToast('Cerrando sesión...', 'info');
            setTimeout(() => {
                location.reload();
            }, 1500);
        }
    }

    // ========================================
    // Lógica de Formularios y Modales
    // ========================================
    async function saveInvoice(event) {
        event.preventDefault();
        const form = event.target;
        const newInvoice = {
            id: Date.now(),
            invoice_number: `F001-${String(AppState.invoiceCounter++).padStart(4, '0')}`,
            clientRuc: form.clientRuc.value,
            clientName: form.clientName.value,
            currency: form.currency.value,
            amount: parseFloat(form.amount.value),
            status: 'Pendiente',
            isExport: form.isExportInvoice.checked,
            date: new Date().toISOString().split('T')[0],
            file: form.invoiceFile.files[0] ? form.invoiceFile.files[0].name : null
        };

        AppState.invoices.push(newInvoice);
        showToast('✅ Factura guardada correctamente.', 'success');
        closeModal('newInvoice');
        form.reset();
        handleCurrencyChange('PEN');
        renderInvoices();
        renderDashboard();
    }
    
    async function savePayment(event) {
        event.preventDefault();
        showToast('✅ Cobro registrado correctamente (simulado).', 'success');
        closeModal('registerPayment');
        document.getElementById('paymentForm').reset();
        updateCurrencySymbols('PEN', 'paymentForm');
    }

    async function saveTimeEntry(event) {
        event.preventDefault();
        const form = event.target;
        const employeeId = form.employeeId.value;
        const employee = AppState.employees.find(e => e.dni === employeeId);
        if (!employee) {
            showToast('Por favor, seleccione un empleado válido.', 'error');
            return;
        }

        const newEntry = {
            id: Date.now(),
            dni: employee.dni,
            name: `${employee.firstName} ${employee.lastName}`,
            avatar: employee.avatar,
            type: form.entryType.value,
            datetime: form.entryDateTime.value,
            entryTime: form.entryType.value.includes('Entrada') ? form.entryDateTime.value.split(' ')[1] : '--:--',
            exitTime: form.entryType.value.includes('Salida') ? form.entryDateTime.value.split(' ')[1] : '--:--',
            status: form.entryType.value.includes('Entrada') ? 'En jornada' : 'Completo'
        };
        AppState.timeEntries.push(newEntry);
        
        renderTimeTracking();
        showToast(`✅ Asistencia de ${newEntry.type} registrada para ${newEntry.name}.`, 'success');
        closeModal('timeEntry');
    }

    async function saveEmployee(event) {
        event.preventDefault();
        const form = event.target;
        const dni = form.employeeDni.value;
        const firstName = form.employeeFirstName.value;
        const lastName = form.employeeLastName.value;

        if (AppState.employees.some(e => e.dni === dni)) {
            showToast(`El DNI ${dni} ya está registrado.`, 'error');
            return;
        }
        
        const avatar = `${firstName[0] || ''}${lastName[0] || ''}`.toUpperCase();
        const newEmployee = { dni, firstName, lastName, avatar };
        AppState.employees.push(newEmployee);
        
        renderEmployees();
        renderEmployeeOptions();
        showToast(`✅ Empleado ${firstName} ${lastName} registrado.`, 'success');
        closeModal('newEmployee');
        form.reset();
    }

    function calculateTotal(returnTotal = false) {
        const form = document.getElementById('invoiceForm');
        const isExport = form.isExportInvoice.checked;
        const amount = parseFloat(form.amount.value) || 0;
        const totalAmountGroup = document.getElementById('totalAmountGroup');
        
        let total;
        if (isExport) {
            total = amount;
            totalAmountGroup.classList.add('hidden');
        } else {
            total = amount * (1 + CONFIG.IGV_RATE);
            totalAmountGroup.classList.remove('hidden');
        }
        
        const currency = form.currency.value;
        const symbol = currency === 'PEN' ? 'S/' : '$';
        
        form.totalAmount.value = `${symbol} ${total.toFixed(2)}`;

        if (returnTotal) return total;
    }

    function showModal(modalId) { 
        const modal = document.getElementById(modalId + 'Modal');
        if (!modal) return;
        
        if (modalId === 'timeEntry') {
            const now = new Date();
            const formattedDateTime = now.toLocaleString('es-PE', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).replace(',', '');
            modal.querySelector('[name="entryDateTime"]').value = formattedDateTime;
        }

        modal.classList.add('active');
    }
    function closeModal(modalId) { 
        const modal = document.getElementById(modalId + 'Modal');
        if(modal) modal.classList.remove('active');
    }
    
    function downloadInvoice(invoiceId) {
        const invoice = AppState.invoices.find(inv => inv.id === invoiceId);
        if (invoice && invoice.file) {
             showToast(`Simulando descarga de: ${invoice.file}...`, 'info');
        } else {
            showToast(`Factura #${invoice.invoice_number} no tiene archivo adjunto.`, 'warning');
        }
    }
    
    function handleFileUpload(files) {
        for (const file of files) {
            showToast(`Archivo "${file.name}" subido.`, 'success');
        }
    }

    // ========================================
    // Eventos y Utilidades
    // ========================================
    function setupEventListeners() {
        const handleTabClick = (tabName) => {
            if (tabName) showTab(tabName);
        };

        document.body.addEventListener('click', e => {
            if (e.target.matches('.modal-overlay')) {
                const modalId = e.target.parentElement.id.replace('Modal', '');
                closeModal(modalId);
            }
            const navItem = e.target.closest('.nav-item');
            if(navItem) handleTabClick(navItem.dataset.tab);
        });
        
        document.getElementById('bottomNav').addEventListener('click', e => {
            e.preventDefault();
            const navItem = e.target.closest('.bottom-nav-item');
            if(navItem) handleTabClick(navItem.dataset.tab);
        });
        
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.querySelector('#paymentForm [name="paymentDate"]');
        if(dateInput) dateInput.value = today;
    }

    function showTab(tabName) {
        if (!tabName) return;
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        const tabElement = document.getElementById(tabName);
        if(tabElement) tabElement.classList.add('active');
        
        document.querySelectorAll('.nav-item, .bottom-nav-item').forEach(i => {
            i.classList.toggle('active', i.dataset.tab === tabName);
        });
        
        document.getElementById('pageTitle').textContent = tabName.charAt(0).toUpperCase() + tabName.slice(1);
        
        if (window.innerWidth <= 1024) {
            document.getElementById('sidebar').classList.remove('active');
        }
    }
    
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    function deleteItem(type, id) {
        if (!confirm('¿Estás seguro de que deseas eliminar este registro?')) {
            return;
        }

        let itemArray;
        let renderFunctions = [];
        let idKey = (type === 'employee') ? 'dni' : 'id';

        switch (type) {
            case 'invoice':
                itemArray = AppState.invoices;
                renderFunctions = [renderInvoices, renderDashboard];
                break;
            case 'employee':
                itemArray = AppState.employees;
                renderFunctions = [renderEmployees, renderEmployeeOptions];
                break;
            case 'timeEntry':
                itemArray = AppState.timeEntries;
                renderFunctions = [renderTimeTracking];
                break;
            default:
                showToast('Tipo de dato no válido para eliminar.', 'error');
                return;
        }

        const index = itemArray.findIndex(item => String(item[idKey]) === String(id));
        
        if (index > -1) {
            itemArray.splice(index, 1);
            renderFunctions.forEach(fn => fn());
            showToast('Registro eliminado correctamente.', 'success');
        } else {
            showToast('No se pudo encontrar el registro para eliminar.', 'error');
        }
    }

    function downloadFullBackup() {
        showToast('📥 Generando respaldo completo...', 'info');

        const toCsv = (data, headers) => {
            const headerRow = headers.join(',') + '\n';
            const dataRows = data.map(row => 
                headers.map(header => {
                    let cell = row[header] === null || row[header] === undefined ? '' : `"${String(row[header]).replace(/"/g, '""')}"`;
                    return cell;
                }).join(',')
            ).join('\n');
            return headerRow + dataRows;
        };

        let fullCsv = 'SECCIÓN: FACTURAS\n';
        const invoiceHeaders = ['id', 'invoice_number', 'clientRuc', 'clientName', 'currency', 'amount', 'status', 'isExport', 'date'];
        fullCsv += toCsv(AppState.invoices, invoiceHeaders) + '\n\n';

        fullCsv += 'SECCIÓN: EMPLEADOS\n';
        const employeeHeaders = ['dni', 'firstName', 'lastName'];
        fullCsv += toCsv(AppState.employees, employeeHeaders) + '\n\n';

        fullCsv += 'SECCIÓN: REGISTRO DE ASISTENCIA\n';
        const timeEntryHeaders = ['id', 'dni', 'name', 'type', 'datetime'];
        fullCsv += toCsv(AppState.timeEntries, timeEntryHeaders) + '\n\n';

        const blob = new Blob([fullCsv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `tecsitel_respaldo_completo_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('✅ Respaldo descargado.', 'success');
    }

    </script>
</body>
</html>
